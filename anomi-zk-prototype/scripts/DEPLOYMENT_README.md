# Deployment Scripts

Scripts for deploying and testing ZK2P on Solana devnet.

---

## Devnet Deployment

### Quick Start (3 Steps)

**Step 1: Deploy Programs**
```powershell
cd anomi-zk-prototype
.\scripts\deploy-devnet.ps1          # Windows
# or
./scripts/deploy-devnet.sh           # Linux/WSL
```

**Step 2: Create Test Token**
```powershell
.\scripts\create-test-token.ps1      # Windows
# or
./scripts/create-test-token.sh       # Linux/WSL
```

**Step 3: Initialize Market**
```bash
# Token mint saved automatically, or get it from scripts/test-token-mint.txt
ts-node scripts/init-devnet.ts <TOKEN_MINT_ADDRESS>
```

**Done!** Market is live on devnet.

---

## Scripts Overview

### deploy-devnet.ps1 / .sh

**Purpose:** Deploy all programs to Solana devnet

**What it does:**
1. Configures Solana CLI for devnet
2. Checks SOL balance, airdrops if needed
3. Builds Anchor programs
4. Deploys to devnet
5. Saves program IDs to `devnet-config.json`

**Output:** `scripts/devnet-config.json` with program addresses

**Usage:**
```powershell
.\scripts\deploy-devnet.ps1
```

### create-test-token.ps1 / .sh

**Purpose:** Create SPL token for testing on devnet

**What it does:**
1. Creates SPL token (6 decimals)
2. Creates token account
3. Mints 100,000 test tokens
4. Saves mint address to file

**Output:** `scripts/test-token-mint.txt`

**Usage:**
```powershell
.\scripts\create-test-token.ps1
```

### init-devnet.ts

**Purpose:** Initialize market accounts on devnet

**What it does:**
1. Reads program IDs from `devnet-config.json`
2. Initializes escrow vault PDA
3. Initializes market PDA
4. Initializes order book PDA  
5. Saves UI config to `demo-ui/config.json`

**Requires:** Token mint address as argument

**Usage:**
```bash
ts-node scripts/init-devnet.ts <TOKEN_MINT_ADDRESS>
```

### test-production.ps1 / .sh

**Purpose:** Run comprehensive test suite

**What it does:**
1. Builds programs
2. Runs unit tests
3. Runs integration tests
4. Generates test report

**Usage:**
```powershell
.\scripts\test-production.ps1
```

---

## Configuration Files

### devnet-config.json

Generated by `deploy-devnet` script.

**Contains:**
- Network (devnet)
- Program IDs (market, order_store, order_processor)
- Deployment timestamp

**Used by:** init-devnet.ts

### demo-ui/config.json

Generated by `init-devnet.ts` script.

**Contains:**
- Network and RPC endpoint
- Program ID
- Token mint
- PDA addresses (market, orderBook, escrow)

**Used by:** UI when connecting to devnet

### test-token-mint.txt

Generated by `create-test-token` script.

**Contains:** SPL token mint address

**Used by:** Quick reference for init-devnet.ts

---

## Workflow

**Complete Deployment Workflow:**

```
1. deploy-devnet.ps1
   ↓
   Creates: devnet-config.json
   
2. create-test-token.ps1
   ↓
   Creates: test-token-mint.txt
   
3. init-devnet.ts <TOKEN_MINT>
   ↓
   Creates: demo-ui/config.json
   
4. Done! Market live on devnet
```

---

## Testing After Deployment

### Verify on Explorer

1. Get PDAs from `demo-ui/config.json`
2. Visit Solana Explorer:
   ```
   https://explorer.solana.com/address/<PDA>?cluster=devnet
   ```
3. Verify accounts exist and have correct data

### Test via CLI

```bash
# Check market account
anchor run test-devnet

# Or manually
ts-node scripts/test-place-order.ts
```

---

## Troubleshooting

### Programs won't deploy

**Check:**
- Sufficient SOL balance (`solana balance`)
- Correct network (`solana config get`)
- Programs build successfully (`anchor build`)

**Fix:**
```bash
solana airdrop 2 --url devnet
```

### Token creation fails

**Check:**
- Connected to devnet
- SOL balance > 0.1

**Fix:**
```bash
solana config set --url devnet
solana airdrop 1
```

### Initialization fails

**Check:**
- Programs deployed (check devnet-config.json exists)
- Token mint is valid
- Sufficient SOL

**Fix:**
- Redeploy if needed
- Check token mint address
- Airdrop more SOL

---

## Next Steps After Deployment

1. **Update UI** - Add Phantom wallet connection
2. **Test on Devnet** - Place orders via UI
3. **Multi-User Test** - Test with multiple wallets
4. **Validate MVP** - Confirm all features work

---

**For detailed guide, see:** `DEVNET_DEPLOYMENT_GUIDE.md`

