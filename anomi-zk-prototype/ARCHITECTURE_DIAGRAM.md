# Phase 2B Architecture Diagram

## Complete Settlement Flow with PDA Locking

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                         PHASE 1: ORDER PLACEMENT                          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    ğŸ‘© Alice (Seller)                          ğŸ“¦ Market Program
         â”‚                                            â”‚
         â”‚  place_ask_order(100 USDC @ $1.00)       â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
         â”‚                                            â”‚
         â”‚         Transfer 100 USDC to Escrow       â”‚
         â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
         â”‚                                            â”‚
         â”‚                                            â–¼
         â”‚                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                                    â”‚  Order Book   â”‚
         â”‚                                    â”‚  PDA          â”‚
         â”‚                                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
         â”‚                                    â”‚ â€¢ Alice: 100  â”‚
         â”‚                                    â”‚   @ $1.00     â”‚
         â”‚                                    â”‚ â€¢ created_at  â”‚
         â”‚                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                            â”‚
         â”‚                                            â–¼
         â”‚                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                                    â”‚ Escrow Vault  â”‚
         â”‚                                    â”‚ (SPL Token)   â”‚
         â”‚                                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
         â”‚                                    â”‚ ğŸ’° 100 USDC   â”‚
         â”‚                                    â”‚ locked        â”‚
         â”‚                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    PHASE 2: MATCHING (1-to-1 Pairing)                     â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    ğŸ‘¨ Bob (Buyer)                             ğŸ“¦ Market Program
         â”‚                                            â”‚
         â”‚  create_bid(100 USDC @ $1.05)             â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
         â”‚                                            â”‚
         â”‚                                            â–¼
         â”‚                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                                    â”‚ Price-Time    â”‚
         â”‚                                    â”‚ Priority Sort â”‚
         â”‚                                    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                            â”‚
         â”‚                                    Find best match
         â”‚                                    (Alice @ $1.00)
         â”‚                                            â”‚
         â”‚                                            â–¼
         â”‚                              â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
         â”‚                              â•‘   CREATE MATCHED ORDER PDA   â•‘
         â”‚                              â•‘   (THE SETTLEMENT LOCK)      â•‘
         â”‚                              â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
         â”‚                              â•‘ Seeds: [buyer, seller, ts]  â•‘
         â”‚                              â•‘                             â•‘
         â”‚                              â•‘ â€¢ buyer: Bob                â•‘
         â”‚                              â•‘ â€¢ seller: Alice             â•‘
         â”‚                              â•‘ â€¢ amount: 100 USDC          â•‘
         â”‚                              â•‘ â€¢ price: $1.00              â•‘
         â”‚                              â•‘ â€¢ escrow_vault: <pubkey>    â•‘
         â”‚                              â•‘ â€¢ token_mint: USDC          â•‘
         â”‚                              â•‘ â€¢ status: PENDING ğŸŸ¡        â•‘
         â”‚                              â•‘ â€¢ deadline: now + 24hrs     â•‘
         â”‚                              â•‘ â€¢ locked_by: None           â•‘
         â”‚                              â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         â”‚                                            â”‚
         â”‚        Match Created - Pay Alice!          â”‚
         â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
         â”‚                                            â”‚


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘              PHASE 3: OFF-CHAIN PAYMENT (Real World)                      â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    ğŸ‘¨ Bob                                      ğŸ‘© Alice
         â”‚                                            â”‚
         â”‚    "Send me $100 via PayPal"              â”‚
         â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
         â”‚                                            â”‚
         â”‚  ğŸ’¸ $100 USD via PayPal                   â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
         â”‚                                            â”‚
         â”‚        "Payment received!"                 â”‚
         â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
         â”‚                                            â”‚
         â–¼                                            â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
    â”‚ Bob generatesâ”‚                                 â”‚
    â”‚ ZK Proof:    â”‚                                 â”‚
    â”‚ "I paid Aliceâ”‚                                 â”‚
    â”‚  $100 PayPal"â”‚                                 â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘        PHASE 4: SETTLEMENT (Atomic with PDA Locking)                      â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    ğŸ‘¨ Bob                          ğŸ”’ OrderProcessor              ğŸ“¦ Market
         â”‚                                 â”‚                          â”‚
         â”‚  finalize_trade(               â”‚                          â”‚
         â”‚    matched_order_pda,           â”‚                          â”‚
         â”‚    zk_proof                     â”‚                          â”‚
         â”‚  )                              â”‚                          â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                          â”‚
         â”‚                                 â”‚                          â”‚
         â”‚                                 â–¼                          â”‚
         â”‚                          Check PDA Status                  â”‚
         â”‚                          (must be Pending)                 â”‚
         â”‚                                 â”‚                          â”‚
         â”‚                                 â–¼                          â”‚
         â”‚                          Check Deadline                    â”‚
         â”‚                          (< 24hrs elapsed)                 â”‚
         â”‚                                 â”‚                          â”‚
         â”‚                                 â–¼                          â”‚
         â”‚                      â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—             â”‚
         â”‚                      â•‘   ğŸ”’ LOCK PDA         â•‘             â”‚
         â”‚                      â•‘   status = InProgress â•‘             â”‚
         â”‚                      â•‘   locked_by = Bob     â•‘             â”‚
         â”‚                      â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•             â”‚
         â”‚                                 â”‚                          â”‚
         â”‚                                 â”‚ PDA Locked!              â”‚
         â”‚                                 â”‚ (prevents re-entrancy)   â”‚
         â”‚                                 â”‚                          â”‚
         â”‚                                 â–¼                          â”‚
         â”‚                          Validate ZK Proof                 â”‚
         â”‚                          (groth16_verify)                  â”‚
         â”‚                                 â”‚                          â”‚
         â”‚                                 â”‚ âœ… Proof Valid           â”‚
         â”‚                                 â”‚                          â”‚
         â”‚                                 â–¼                          â”‚
         â”‚                          CPI: release_escrowed_funds()     â”‚
         â”‚                                 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
         â”‚                                 â”‚                          â”‚
         â”‚                                 â”‚                          â–¼
         â”‚                                 â”‚                   Verify Caller
         â”‚                                 â”‚                   (only OrderProc)
         â”‚                                 â”‚                          â”‚
         â”‚                                 â”‚                          â–¼
         â”‚                                 â”‚                   Verify PDA Status
         â”‚                                 â”‚                   (must be InProgress)
         â”‚                                 â”‚                          â”‚
         â”‚                                 â”‚                          â–¼
         â”‚                                 â”‚                   Verify Vault
         â”‚                                 â”‚                   (matches PDA)
         â”‚                                 â”‚                          â”‚
         â”‚                                 â”‚                          â–¼
         â”‚                                 â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                                 â”‚            â”‚  Escrow Vault       â”‚
         â”‚                                 â”‚            â”‚  Sign with PDA Auth â”‚
         â”‚                                 â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                 â”‚                       â”‚
         â”‚  ğŸ’° 100 USDC Received!          â”‚          Transfer     â”‚
         â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                 â”‚                          â”‚
         â”‚                                 â–¼                          â”‚
         â”‚                      â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—             â”‚
         â”‚                      â•‘   âœ… FINALIZE PDA     â•‘             â”‚
         â”‚                      â•‘   status = Settled    â•‘             â”‚
         â”‚                      â•‘   settled_at = now    â•‘             â”‚
         â”‚                      â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•             â”‚
         â”‚                                 â”‚                          â”‚
         â”‚        Settlement Complete!     â”‚                          â”‚
         â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                          â”‚
         â”‚                                 â”‚                          â”‚


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                            FINAL STATE                                    â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    ğŸ‘¨ Bob                                           ğŸ‘© Alice
    âœ… Has 100 USDC                                  âœ… Has $100 USD
    (on-chain tokens)                                (off-chain fiat)

    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘   MatchedOrder PDA (Immutable)    â•‘
    â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
    â•‘ â€¢ status: SETTLED âœ…              â•‘
    â•‘ â€¢ settled_at: 1729471234          â•‘
    â•‘ â€¢ Cannot be replayed              â•‘
    â•‘ â€¢ Permanent on-chain record       â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                       SECURITY GUARANTEES                                 â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    1. ğŸ”’ NO DOUBLE-SPENDING
       â–¸ PDA locks to InProgress before any transfers
       â–¸ Once Settled, cannot process again

    2. ğŸ›¡ï¸ NO RE-ENTRANCY
       â–¸ locked_by field prevents concurrent settlement
       â–¸ Status checked at every step

    3. ğŸ’° NO FUND LOSS
       â–¸ Escrow vault linked in PDA
       â–¸ Deadline enforcement (24hr)
       â–¸ Auto-refund if expired

    4. âš›ï¸ ATOMIC SETTLEMENT
       â–¸ Either: (proof valid â†’ escrow released â†’ PDA settled)
       â–¸ Or: (proof invalid â†’ everything reverted)

    5. ğŸ” ACCESS CONTROL
       â–¸ Only OrderProcessor can release escrow
       â–¸ Only correct buyer receives tokens
       â–¸ PDA seeds enforce 1-to-1 pairing


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    ALTERNATIVE: EXPIRED SETTLEMENT                        â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    If Bob never submits proof within 24hrs:

    ğŸ‘© Alice                            ğŸ“¦ Market Program
         â”‚                                     â”‚
         â”‚  refund_expired_order()             â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
         â”‚                                     â”‚
         â”‚                                     â–¼
         â”‚                              Check Deadline
         â”‚                              (> 24hrs passed)
         â”‚                                     â”‚
         â”‚                                     â–¼
         â”‚                              Check Status
         â”‚                              (still Pending)
         â”‚                                     â”‚
         â”‚                                     â–¼
         â”‚                     Update: status = Expired
         â”‚                                     â”‚
         â”‚                                     â–¼
         â”‚                     Transfer 100 USDC back to Alice
         â”‚  ğŸ’° Refund Received                 â”‚
         â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
         â”‚                                     â”‚

    Result: Alice gets her tokens back (no loss)
```

## Key Insight: The PDA IS the Settlement Lock

The `MatchedOrder` PDA serves as:
- ğŸ”’ **Lock**: Prevents double-settlement via status field
- ğŸ”— **Bridge**: Links matching â†’ escrow â†’ settlement
- ğŸ§¾ **Receipt**: Permanent on-chain proof of trade
- â° **Timer**: Enforces settlement deadline
- ğŸ›¡ï¸ **Guard**: Only authorized programs can modify

This design ensures **1 buyer â†’ 1 seller â†’ 1 settlement** with no room for exploits.
